<div class="container mt-4">
  <mat-card>
    <mat-card-header>
      <mat-card-title>New Prescription</mat-card-title>
    </mat-card-header>
    <mat-card-content>
      <form
        [formGroup]="prescriptionForm"
        (ngSubmit)="savePrescription()"
        class="d-flex flex-column gap-3 mt-3"
      >
        <!-- Patient Selection -->
        <mat-form-field appearance="outline">
          <mat-label>Patient</mat-label>
          <mat-select formControlName="patientId">
            <mat-option *ngFor="let patient of patients" [value]="patient.id">
              {{ patient.name }} {{ patient.middlename }} {{ patient.lastname }}
            </mat-option>
          </mat-select>
          <mat-error
            *ngIf="prescriptionForm.get('patientId')?.hasError('required')"
          >
            Patient is required
          </mat-error>
        </mat-form-field>

        <!-- Diagnosis -->
        <mat-form-field appearance="outline">
          <mat-label>Diagnosis</mat-label>
          <textarea
            matInput
            formControlName="diagnosis"
            rows="3"
            placeholder="e.g., Acute Bronchitis"
          ></textarea>
          <mat-error
            *ngIf="prescriptionForm.get('diagnosis')?.hasError('required')"
          >
            Diagnosis is required
          </mat-error>
        </mat-form-field>

        <!-- Items Table/List -->
        <h3>Medications</h3>
        <div formArrayName="items">
          <div
            *ngFor="let item of items.controls; let i = index"
            [formGroupName]="i"
            class="item-row"
          >
            <div class="row">
              <div class="col-md-3">
                <mat-form-field appearance="outline" class="w-100">
                  <mat-label>Medication</mat-label>
                  <input
                    matInput
                    formControlName="medication"
                    placeholder="e.g. Amoxicillin"
                  />
                </mat-form-field>
              </div>
              <div class="col-md-2">
                <mat-form-field appearance="outline" class="w-100">
                  <mat-label>Dose</mat-label>
                  <input matInput formControlName="dose" placeholder="500mg" />
                </mat-form-field>
              </div>
              <div class="col-md-2">
                <mat-form-field appearance="outline" class="w-100">
                  <mat-label>Frequency</mat-label>
                  <input
                    matInput
                    formControlName="frequency"
                    placeholder="Every 8h"
                  />
                </mat-form-field>
              </div>
              <div class="col-md-2">
                <mat-form-field appearance="outline" class="w-100">
                  <mat-label>Duration</mat-label>
                  <input
                    matInput
                    formControlName="duration"
                    placeholder="7 days"
                  />
                </mat-form-field>
              </div>
              <div class="col-md-2">
                <mat-form-field appearance="outline" class="w-100">
                  <mat-label>Notes</mat-label>
                  <input
                    matInput
                    formControlName="notes"
                    placeholder="After meals"
                  />
                </mat-form-field>
              </div>
              <div class="col-md-1 d-flex align-items-center">
                <button
                  mat-icon-button
                  color="warn"
                  type="button"
                  (click)="removeItem(i)"
                  *ngIf="items.length > 1"
                >
                  <mat-icon>delete</mat-icon>
                </button>
              </div>
            </div>
          </div>
        </div>

        <button mat-button type="button" (click)="addItem()">
          <mat-icon>add</mat-icon> Add Medication
        </button>

        <div *ngIf="errorMessage" class="alert alert-danger">
          {{ errorMessage }}
        </div>
        <div *ngIf="infoMessage" class="alert alert-success">
          {{ infoMessage }}
        </div>

        <div class="d-flex justify-content-end mt-3">
          <button
            mat-raised-button
            color="primary"
            type="submit"
            [disabled]="prescriptionForm.invalid"
          >
            Create Prescription
          </button>
        </div>
      </form>
    </mat-card-content>
  </mat-card>
</div>
